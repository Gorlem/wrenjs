<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>WREN</title>
    <script src="../out/wren.js"></script>
    <link type="language/wren" module="js" src="../modules/js.wren" />
    <link type="language/wren" module="please" src="https://raw.githubusercontent.com/EvanHahn/wren-please/master/please.wren" />
</head>
<body>

<script type="language/wren" module="main">
// This is inline wren.

import "please" for Please
import "js" for JS, JsObject

var document = JS.wrap("document")

// two native refs not equal
var body = document.property("body")
var body2 = JsObject.new("document.body")
System.print(body.native + " != " + body2.native)
Please.notEqual(body, body2)

// two evaluated strings equal
var bodyString = body.string
var body2String = body2.string
System.print(bodyString + " == " + body2String)
Please.equal(bodyString, body2String)

// clean up
body.free()
body2.free()
System.print(body.string + " , " + body2.string)

var console = JS.wrap("console")
console.callMethod("log", ["'Hello World'"])
console.free()

var product = JS.wrap("42 + 1")
System.print(product.num)

var boolean = JS.wrap("false")
System.print(boolean.bool)
var notBoolean = JS.wrap("!" + boolean.native)
System.print(notBoolean.bool)

document.
  property("body").
  setProperty("innerHTML", " 'cleared!' ")

</script>

<script>
    // This block of code looks for "language/wren" script tags and loads them as 
    // strings in the MODULES object.
    var MODULES = {};
    var imp = document.querySelectorAll('[type="language/wren"]');
    for (var i = imp.length -1 ; i >= 0 ; i--) {
        if (imp[i].hasAttribute('src')) {      
            var url = imp[i].getAttribute('src');
            var module = imp[i].getAttribute('module');  
            var file = new XMLHttpRequest();
            file.onreadystatechange = function() {
                if (file.readyState === 4) {
                    if (file.status === 200) {
                        MODULES[module] = file.responseText;
                    }
                }
            }
            file.open("GET", url, false);
            file.send(null);
        }
    }

    
    // Constructs a new WrenVM
    var vm = new WrenVM();

    // Overrides the default 'writeFn', printing to the body instead of the console.
    vm.writeFn = function(string) {
      document.body.innerHTML += "<code>" + string + '<br> </code>';
    };

    // Overrides the 'loadModuleFn' so that the VM looks for modules in the MODULES object.
    vm.loadModuleFn = function(module) {
        return MODULES[module];
    };

    // Looks for the main script on the page, and runs it as wren code.
    // By now, all the included modules should be loaded into the MODULES object 
    // and ready for use.
    vm.interpret(document.querySelector('[module="main"]').innerHTML.replace(/<[^>]*>/g, ""));
</script>
</body>
</html>
