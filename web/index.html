<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>WREN</title>
    <script src="../out/wren.js"></script>
    <script src="two.min.js"></script>
    <link type="language/wren" module="please" src="https://raw.githubusercontent.com/EvanHahn/wren-please/master/please.wren" />
    <link type="language/wren" module="js" src="../modules/js.wren" />
    <link type="language/wren" module="two" src="../modules/two.wren" />
    <link type="language/wren" module="js-test" src="../modules/js.test.wren" />
</head>
<body>

<div id="canvas"></div>

<script type="language/wren" module="main" src="main.wren"></script>

<script>
    // This block of code looks for "language/wren" script tags and loads them as
    // strings in the MODULES object.
    var MODULES = {};
    var imp = document.querySelectorAll('[type="language/wren"]');
    for (var i = imp.length -1 ; i >= 0 ; i--) {
        if (imp[i].hasAttribute('src')) {
            var url = imp[i].getAttribute('src');
            var module = imp[i].getAttribute('module');
            var file = new XMLHttpRequest();
            file.onreadystatechange = function() {
                if (file.readyState === 4) {
                    if (file.status === 200) {
                        MODULES[module] = file.responseText;
                    }
                }
            }
            file.open("GET", url, false);
            file.send(null);
        }
    }

    // test values used by js.wren.test
    var testValue;
    var testString = "test";
    var testNum = 5.5;
    var testBool = true;


    var config = new WrenConfiguration();
    config.errorFn = function(source_module, line, message) {
        throw(message + " | " + source_module + ":" + line);
    };
    // Overrides the default 'writeFn', printing to the body instead of the console.
    config.writeFn = function(string) {
      document.body.innerHTML += "<code>" + string + '<br> </code>';
    };
    // Overrides the 'loadModuleFn' so that the VM looks for modules in the MODULES object.
    config.loadModuleFn = function(module) {
        return MODULES[module];
    };

    // BIND FOREIGNMETHOD DECLARATION //
    var jsRun = function(vm, x) {
      var string = Wren.getSlotString(vm, 1);
      eval(string);
    };

    var jsRun_string = function(vm) {
      var string = Wren.getSlotString(vm, 1);
      Wren.setSlotString(vm, 0, eval(string).toString())
    };

    var jsRun_num = function(vm) {
      var string = Wren.getSlotString(vm, 1);
      Wren.setSlotDouble(vm, 0, eval(string))
    };

    var jsRun_bool = function(vm) {
      var string = Wren.getSlotString(vm, 1);
      var test = eval(string).toString();
      if (test === 'true') {
        Wren.setSlotBool(vm, 0, 1)
      } else {
        Wren.setSlotBool(vm, 0, 0)
      }
    };

    config.bindForeignMethodFn = function(
      source_module,
      className,
      isStatic,
      signature
    ) {
      if (className === "JS" && signature === "run_(_)") return jsRun;
      if (className === "JS" && signature === "string_(_)") return jsRun_string;
      if (className === "JS" && signature === "num_(_)") return jsRun_num;
      if (className === "JS" && signature === "bool_(_)") return jsRun_bool;
      return null;
    }
    // BIND FOREIGNMETHOD DECLARATION END //



    // Used by js.wren to manage objects.
    Wren.WREN_OBJECTS = {};
    Wren.CURRENT_INDEX = 1;

    WrenVM._lookup = function(id) {
        return Wren.WREN_OBJECTS[id];
    };

    WrenVM._register = function(object) {   for (var index in Wren.WREN_OBJECTS) {
        if (Wren.WREN_OBJECTS[index] === object)
        return index;
      }

      Wren.WREN_OBJECTS[Wren.CURRENT_INDEX] = object;
      Wren.CURRENT_INDEX++;
      return Wren.CURRENT_INDEX - 1;
    };

    WrenVM._free = function(id) {
        Wren.WREN_OBJECTS[id] = null;
    };


    // Constructs a new WrenVM
    var vm = new WrenVM(config);

    // Looks for the main script on the page, and runs it as wren code.
    // By now, all the included modules should be loaded into the MODULES object
    // and ready for use.
    vm.interpret(MODULES.main);
</script>
</body>
</html>
